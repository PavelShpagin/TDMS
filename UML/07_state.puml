@startuml state
!theme plain
title TDMS - State Diagram: Database Lifecycle

[*] --> Initialize

state Initialize {
  [*] --> CheckStorage
  CheckStorage : Check for existing DBs
  CheckStorage --> LoadExisting : Found
  CheckStorage --> CreateNew : Not found
  LoadExisting --> Ready
  CreateNew --> Ready
}

state Ready {
  [*] --> Idle
  
  Idle --> TableOperations : User action
  Idle --> DataOperations : User action
  Idle --> Persistence : Save/Load
  
  state TableOperations {
    [*] --> SelectOp
    SelectOp --> CreateTable : Create
    SelectOp --> DropTable : Drop
    SelectOp --> UnionTables : Union
    CreateTable --> [*]
    DropTable --> [*]
    UnionTables --> [*]
  }
  
  state DataOperations {
    [*] --> InsertRow
    InsertRow --> ValidateData : Submit
    ValidateData --> InsertRow : Invalid
    ValidateData --> [*] : Valid
  }
  
  state Persistence {
    [*] --> ChooseMethod
    ChooseMethod --> LocalSave : Local
    ChooseMethod --> GoogleDrive : Cloud
    
    state GoogleDrive {
      [*] --> Authenticate
      Authenticate --> Upload : Save
      Authenticate --> Download : Load
      Upload --> [*]
      Download --> [*]
    }
    
    LocalSave --> [*]
  }
  
  TableOperations --> Idle
  DataOperations --> Idle
  Persistence --> Idle
}

Ready --> Shutdown : Exit

state Shutdown {
  [*] --> SaveChanges
  SaveChanges --> Cleanup
  Cleanup --> [*]
}

Shutdown --> [*]

note right of GoogleDrive
  Service Account auth
  Drive API v3
end note

note left of DataOperations
  Type validation:
  date, dateInvl
end note

@enduml