@startuml sequence_google_drive
!theme plain
title TDMS - Sequence Diagram: Google Drive Integration

actor User
participant "Web UI" as UI
participant "FastAPI" as API
participant "Database" as DB
participant "Google Drive\nService" as GDrive
participant "Google Cloud" as Cloud

== Save to Google Drive ==

User -> UI: Click "Save to Drive"
activate UI
UI -> API: POST /save_drive\n{name, folder_id}
activate API

API -> DB: get database by name
activate DB
DB -> DB: to_json()
DB -> API: Return JSON data
deactivate DB

API -> GDrive: _get_drive_service()
activate GDrive
GDrive -> GDrive: Load service account
GDrive -> GDrive: Build Drive API client
GDrive -> API: Return service
deactivate GDrive

API -> Cloud: files().create()\n{name.json, content}
activate Cloud
Cloud -> Cloud: Upload file
Cloud -> Cloud: Store in folder
Cloud -> API: Return file_id
deactivate Cloud

API -> UI: 200 OK\n{status: "ok", file_id}
deactivate API
UI -> User: Show success\nDisplay file ID
deactivate UI

== Load from Google Drive ==

User -> UI: Click "Load from Drive"
activate UI
UI -> API: GET /drive_files
activate API

API -> GDrive: _get_drive_service()
activate GDrive
GDrive -> API: Return service
deactivate GDrive

API -> Cloud: files().list()\nq="mimeType='application/json'"
activate Cloud
Cloud -> API: Return file list
deactivate Cloud

API -> UI: Return files array
deactivate API

UI -> User: Display available files
User -> UI: Select file

UI -> API: POST /load_drive\n{name, file_id}
activate API

API -> GDrive: _get_drive_service()
activate GDrive
GDrive -> API: Return service
deactivate GDrive

API -> Cloud: files().get_media(file_id)
activate Cloud
Cloud -> Cloud: Retrieve file content
Cloud -> API: Return JSON content
deactivate Cloud

API -> API: Parse JSON
API -> DB: Database.from_json(data)
activate DB
DB -> DB: Reconstruct database
DB -> API: Return Database instance
deactivate DB

API -> API: Register in _db_registry
API -> UI: 200 OK\n{status: "ok", name}
deactivate API

UI -> UI: Refresh UI
UI -> User: Show loaded database
deactivate UI

note over GDrive
  Service Account Auth:
  - GOOGLE_SERVICE_ACCOUNT_INFO
  - GOOGLE_SERVICE_ACCOUNT_FILE
end note

note over Cloud
  Drive API v3
  Scopes:
  - drive.file
  - drive.readonly
end note

@enduml