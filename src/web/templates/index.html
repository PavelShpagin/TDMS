<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Table Database</title>
    <script src="https://cdn.tailwindcss.com"></script>
    {% if google_client_id and not is_desktop %}
    <meta name="google-signin-client_id" content="{{ google_client_id }}" />
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js" async defer></script>
    {% endif %}
    <script>
                                                {% if google_client_id and not is_desktop %}
                                                let gapiInited = false;
                                                let googleAccessToken = null;
                                                let pickerLoaded = false;
                                                async function initGapi() {
                                                  return new Promise((resolve, reject) => {
                                                    let attempts = 0;
                                                    const maxAttempts = 100; // 10 seconds max

                                                    const wait = () => {
                                                      attempts++;
                                                      console.log(`Google API init attempt ${attempts}/${maxAttempts}`);

                                                      if (window.gapi && window.google) {
                                                        console.log("✅ Google APIs loaded, initializing client...");
                                                        gapi.load("client", async () => {
                                                          try {
                                                            await gapi.client.init({
                                                              apiKey: "{{ google_api_key }}",
                                                              discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"]
                                                            });
                                                            console.log("✅ GAPI client initialized");
                                                            gapiInited = true;

                                                            gapi.load("picker", () => {
                                                              pickerLoaded = !!(window.google && window.google.picker);
                                                              console.log(`✅ Google Picker loaded: ${pickerLoaded}`);
                                                              resolve();
                                                            });
                                                          } catch (e) {
                                                            console.error("❌ GAPI client init error:", e);
                                                            gapiInited = true; // Continue anyway
                                                            resolve();
                                                          }
                                                        });
                                                      } else if (attempts >= maxAttempts) {
                                                        console.error("❌ Google APIs failed to load after 10 seconds");
                                                        toast("Google APIs failed to load. Please refresh the page.", "error");
                                                        reject(new Error("Google APIs timeout"));
                                                      } else {
                                                        setTimeout(wait, 100);
                                                      }
                                                    };
                                                    wait();
                                                  });
                                                }
                                                function signInGoogle() {
                                                  return new Promise((resolve, reject) => {
                                                    if (!"{{ google_client_id }}")
                                                      return reject("No Google client id configured");

                                                    // Show instructions for unverified app screen
                                                    toast("If you see 'Google hasn't verified this app', click 'Advanced' → 'Go to [app name] (unsafe)' to continue", "info");

                                                    google.accounts.oauth2
                                                      .initTokenClient({
                                                        client_id: "{{ google_client_id }}",
                                                        scope:
                                                          "https://www.googleapis.com/auth/drive.readonly",
                                                        prompt: "",
                                                        callback: (resp) => {
                                                          if (resp && resp.access_token) {
                                                            googleAccessToken = resp.access_token;
                                                            toast("✅ Google Drive connected successfully!", "success");
                                                            resolve(resp.access_token);
                                                          } else reject("No access token");
                                                        },
                                                      })
                                                      .requestAccessToken();
                                                  });
                                                }
                    {% else %}
                    // Desktop mode: No Google functionality at all
                    let gapiInited = false;
                    let googleAccessToken = null;
                    let pickerLoaded = false;

                    async function initGapi() {
                      console.log("Desktop: Google API disabled");
                      return Promise.resolve();
                    }
                    function signInGoogle() {
                      toast("Desktop mode: Use manual file operations instead", "info");
                      return Promise.reject("Google Drive OAuth disabled in desktop mode");
                    }
                    {% endif %}
                                                {% if google_client_id and not is_desktop %}
                                                async function ensureGoogleAuth() {
                                                  if (!googleAccessToken) await signInGoogle();
                                                  if (!gapiInited) await initGapi();
                                                }
                                                {% else %}
                                                async function ensureGoogleAuth() {
                                                  console.log("Desktop: No Google auth needed");
                                                  return Promise.resolve();
                                                }
                                                {% endif %}

                                                function waitUntil(cond, timeoutMs = 5000, intervalMs = 120) {
                                                  return new Promise((resolve) => {
                                                    const start = Date.now();
                                                    const tick = () => {
                                                      if (cond()) return resolve(true);
                                                      if (Date.now() - start >= timeoutMs) return resolve(false);
                                                      setTimeout(tick, intervalMs);
                                                    };
                                                    tick();
                                                  });
                                                }

                                                {% if google_client_id %}
                                                async function ensurePickerReady() {
                                                  if (!gapiInited) await initGapi();
                                                  const ok = await waitUntil(
                                                    () => window.google && window.google.picker,
                                                    6000,
                                                    120
                                                  );
                                                  pickerLoaded = !!ok;
                                                  return ok;
                                                }
                                                function buildPickerViewDocs(onPicked) {
                                                  if (
                                                    !pickerLoaded ||
                                                    !"{{ google_api_key }}" ||
                                                    !(window.google && window.google.picker)
                                                  )
                                                    return openDriveRestFallback();
                                                  const picker = new google.picker.PickerBuilder()
                                                    .setOAuthToken(googleAccessToken)
                                                    .setDeveloperKey("{{ google_api_key }}")
                                                    .setAppId("{{ google_app_id }}")
                                                    .addView(
                                                      new google.picker.DocsView()
                                                        .setIncludeFolders(false)
                                                        .setSelectFolderEnabled(false)
                                                        .setMimeTypes("application/json")
                                                    )
                                                    .setCallback((data) => {
                                                      if (
                                                        data.action === google.picker.Action.PICKED &&
                                                        data.docs &&
                                                        data.docs[0]
                                                      ) {
                                                        onPicked(data.docs[0]);
                                                      }
                                                    })
                                                    .build();
                                                  picker.setVisible(true);
                                                }
                                                function buildPickerSave(name, onPicked) {
                                                  if (
                                                    !pickerLoaded ||
                                                    !"{{ google_api_key }}" ||
                                                    !(window.google && window.google.picker)
                                                  )
                                                    return; // no-op; export already works via REST
                                                  const picker = new google.picker.PickerBuilder()
                                                    .setOAuthToken(googleAccessToken)
                                                    .setDeveloperKey("{{ google_api_key }}")
                                                    .setAppId("{{ google_app_id }}")
                                                    .addView(new google.picker.DocsUploadView().setParent("root"))
                                                    .enableFeature(google.picker.Feature.NAV_HIDDEN)
                                                    .enableFeature(google.picker.Feature.MULTISELECT_DISABLED)
                                                    .setCallback((data) => {
                                                      if (
                                                        data.action === google.picker.Action.PICKED &&
                                                        data.docs &&
                                                        data.docs[0]
                                                      ) {
                                                        onPicked(data.docs[0]);
                                                      }
                                                    })
                                                    .build();
                                                  picker.setVisible(true);
                                                }

                                                async function openDriveRestFallback() {
                                                  try {
                                                    // List recent JSON files via Drive REST
                                                    const listResp = await fetch(
                                                      "https://www.googleapis.com/drive/v3/files?q=mimeType%3D%22application%2Fjson%22&fields=files(id%2Cname%2CmodifiedTime)&orderBy=modifiedTime%20desc",
                                                      {
                                                        headers: { Authorization: "Bearer " + googleAccessToken },
                                                      }
                                                    );
                                                    if (listResp.status === 401) {
                                                      // Try to refresh using stored refresh token
                                                      const rt = localStorage.getItem('google_refresh_token');
                                                      if (rt) {
                                                        try {
                                                          const clientId = "{{ google_client_id or '' }}";
                                                          const clientSecret = "{{ google_client_secret or '' }}";
                                                          const r = await fetch('https://oauth2.googleapis.com/token', {
                                                            method: 'POST',
                                                            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                                                            body: new URLSearchParams({
                                                              client_id: clientId,
                                                              refresh_token: rt,
                                                              grant_type: 'refresh_token',
                                                              ...(clientSecret ? { client_secret: clientSecret } : {})
                                                            })
                                                          });
                                                          if (r.ok) {
                                                            const td = await r.json();
                                                            googleAccessToken = td.access_token;
                                                            // retry once
                                                            return await openDriveRestFallback();
                                                          }
                                                        } catch {}
                                                      }
                                                    }
                                                    if (!listResp.ok) {
                                                      let info = "";
                                                      try { info = await listResp.text(); } catch {}
                                                      return toast("Error: cannot query Drive (" + listResp.status + ") " + info, "error");
                                                    }
                                                    const data = await listResp.json();
                                                    const files = data.files || [];
                                                    const modal = document.createElement("div");
                                                    modal.className =
                                                      "fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50";
                                                    modal.innerHTML = `
                                                      <div class="w-full max-w-2xl rounded-xl border border-slate-800 bg-slate-900 p-4">
                                                        <div class="flex items-center justify-between">
                                                          <h3 class="text-lg font-semibold">Load from Google Drive</h3>
                                                          <button class="px-2 py-1 rounded bg-slate-800 text-slate-200 border border-slate-700" data-close>Close</button>
                                                        </div>
                                                        <div class="mt-3 max-h-[60vh] overflow-auto divide-y divide-slate-800">
                                                          ${files
                                                            .map(
                                                              (f) => `
                                                            <div class='py-2 flex items-center justify-between'>
                                                              <div class='min-w-0'>
                                                                <div class='text-slate-100 truncate' title='${f.name}'>${
                                                                f.name
                                                              }</div>
                                                                <div class='text-xs text-slate-500'>${
                                                                  f.modifiedTime || ""
                                                                }</div>
                                                              </div>
                                                              <button class='px-3 py-1.5 rounded bg-emerald-600 hover:bg-emerald-500 text-white' data-pick='${
                                                                f.id
                                                              }' data-name='${f.name}'>Load</button>
                                                            </div>
                                                          `
                                                            )
                                                            .join("")}
                                                        </div>
                                                      </div>`;
                                                    document.body.appendChild(modal);
                                                    modal
                                                      .querySelector("[data-close]")
                                                      ?.addEventListener("click", () => modal.remove());
                                                    Array.from(modal.querySelectorAll("[data-pick]")).forEach((btn) => {
                                                      btn.addEventListener("click", async () => {
                                                        const id = btn.getAttribute("data-pick");
                                                        const fname = (
                                                          btn.getAttribute("data-name") || "drive_db"
                                                        ).replace(/\.json$/, "");
                                                        const contentResp = await fetch(
                                                          `https://www.googleapis.com/drive/v3/files/${id}?alt=media`,
                                                          {
                                                            headers: {
                                                              Authorization: "Bearer " + googleAccessToken,
                                                              Accept: "application/json",
                                                            },
                                                          }
                                                        );
                                                        if (!contentResp.ok) {
                                                          let info = "";
                                                          try { info = await contentResp.text(); } catch {}
                                                          return toast("Error: cannot download file (" + contentResp.status + ") " + info, "error");
                                                        }
                                                        let json;
                                                        try {
                                                          json = await contentResp.json();
                                                        } catch {
                                                          return toast("Error: not a JSON file", "error");
                                                        }
                                                        const name = prompt("Name for database:", fname) || fname;
                                                        // Confirm replace if exists
                                                        try {
                                                          const dbs = await api("/databases");
                                                          if (
                                                            dbs &&
                                                            Array.isArray(dbs.databases) &&
                                                            dbs.databases.includes(name)
                                                          ) {
                                                            const ok = confirm(
                                                              `Database \"${name}\" exists. Replace it?`
                                                            );
                                                            if (!ok) return;
                                                          }
                                                        } catch {}
                                                        const res = await api("/import_database", "POST", {
                                                          name,
                                                          data: json,
                                                        });
                                                        if (res && res.status === "ok") {
                                                          toast("Loaded from Drive");
                                                          modal.remove();
                                                          await loadDatabases();
                                                        } else toast(`Error: ${res?.detail || "failed"}`, "error");
                                                      });
                                                    });
                                                  } catch (e) {
                                                    toast("Error: Drive fallback failed", "error");
                                                  }
                                                }
                                                async function exportDbToDrive(name) {
                                                  try {
                                                    await ensureGoogleAuth();
                                                    await ensurePickerReady();
                                                    const tables = await api("/tables");
                                                    const payload = JSON.stringify({ name, tables: tables.tables });
                                                    const res = await fetch(
                                                      "https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id",
                                                      {
                                                        method: "POST",
                                                        headers: { Authorization: "Bearer " + googleAccessToken },
                                                        body: buildMultipart({ name: name + ".json" }, payload),
                                                      }
                                                    );
                                                    const json = await res.json();
                                                    if (json && json.id) toast("Saved to Drive: " + json.id);
                                                    else toast("Error: Drive upload failed", "error");
                                                  } catch (e) {
                                                    toast("Error: Google auth/upload failed", "error");
                                                  }
                                                }
                                                function buildMultipart(meta, body) {
                                                  const boundary = "-------314159265358979323846";
                                                  const delimiter = "\r\n--" + boundary + "\r\n";
                                                  const closeDelim = "\r\n--" + boundary + "--";
                                                  const contentType = "application/json";
                                                  const base64Data = btoa(unescape(encodeURIComponent(body)));
                                                  const multipartRequestBody =
                                                    delimiter +
                                                    "Content-Type: application/json\r\n\r\n" +
                                                    JSON.stringify(meta) +
                                                    delimiter +
                                                    "Content-Type: " +
                                                    contentType +
                                                    "\r\n" +
                                                    "Content-Transfer-Encoding: base64\r\n\r\n" +
                                                    base64Data +
                                                    closeDelim;
                                                  return new Blob([multipartRequestBody], {
                                                    type: "multipart/related; boundary=" + boundary,
                                                  });
                                                }
                                                {% else %}
                                                // Desktop mode: Use browser-based authentication
                                                async function ensurePickerReady() {
                                                  return false; // Always use REST fallback in desktop mode
                                                }
                                                function buildPickerViewDocs(onPicked) {
                                                  // Desktop mode always uses REST fallback
                                                  return openDriveRestFallback();
                                                }
                                                function buildPickerSave(name, onPicked) {
                                                  toast("Google Drive export requires web browser authentication", "info");
                                                  const currentPort = window.location.port || '8000';
                                                  const redirectUri = `http://127.0.0.1:${currentPort}/oauth/callback`;
                                                  const authUrl = `https://accounts.google.com/oauth/authorize?client_id={{ google_client_id or 'YOUR_CLIENT_ID' }}&redirect_uri=${encodeURIComponent(redirectUri)}&scope=https://www.googleapis.com/auth/drive.readonly&response_type=code&access_type=offline`;
                                                  window.open(authUrl, "_blank");
                                                }
                                    async function openDrivePickerAndImport() {
                                      console.log("openDrivePickerAndImport called");
                                      {% if is_desktop %}
                                      // Desktop Mode: Simple manual code flow
                                      try {
                                        console.log("Desktop mode detected");
                                        const clientId = "{{ google_client_id or '' }}";
                                        const clientSecret = "{{ google_client_secret or '' }}";
                                        console.log("Desktop OAuth starting with clientId:", clientId);

                                        if (!clientId) {
                                          toast("Missing desktop client id", "error");
                                          return;
                                        }

                                        // Use urn:ietf:wg:oauth:2.0:oob for desktop apps
                                        const authUrl = `https://accounts.google.com/o/oauth2/v2/auth?` +
                                          `client_id=${encodeURIComponent(clientId)}&` +
                                          `redirect_uri=${encodeURIComponent('urn:ietf:wg:oauth:2.0:oob')}&` +
                                          `response_type=code&` +
                                          `scope=${encodeURIComponent('https://www.googleapis.com/auth/drive.readonly')}&` +
                                          `access_type=offline&` +
                                          `prompt=consent`;

                                        // Copy URL to clipboard
                                        try {
                                          await navigator.clipboard.writeText(authUrl);
                                          toast("OAuth URL copied to clipboard", "info");
                                        } catch (e) {
                                          console.log("Could not copy to clipboard");
                                        }

                                        // Show instructions with the URL
                                        const authCode = prompt(
                                          `GOOGLE DRIVE AUTHORIZATION:\n\n` +
                                          `1. Open this URL in your browser (it's also copied to clipboard):\n` +
                                          `${authUrl}\n\n` +
                                          `2. Authorize the app\n` +
                                          `3. Copy the authorization code\n` +
                                          `4. Paste it below:`
                                        );

                                        if (!authCode || !authCode.trim()) {
                                          toast("Authorization cancelled", "warning");
                                          return;
                                        }

                                        toast("Exchanging code for access token...", "info");

                                        // Exchange code for tokens
                                        const tokenResponse = await fetch("https://oauth2.googleapis.com/token", {
                                          method: "POST",
                                          headers: { "Content-Type": "application/x-www-form-urlencoded" },
                                          body: new URLSearchParams({
                                            client_id: clientId,
                                            client_secret: clientSecret,
                                            code: authCode.trim(),
                                            grant_type: "authorization_code",
                                            redirect_uri: "urn:ietf:wg:oauth:2.0:oob"
                                          })
                                        });

                                        if (tokenResponse.ok) {
                                          const tokenData = await tokenResponse.json();
                                          googleAccessToken = tokenData.access_token;
                                          console.log("OAuth success, token received");

                                          if (tokenData.refresh_token) {
                                            localStorage.setItem('google_refresh_token', tokenData.refresh_token);
                                            toast("Google Drive connected! Future access will be instant!", "success");
                                          } else {
                                            toast("Google Drive connected successfully!", "success");
                                          }

                                          await openDriveRestFallback();
                                        } else {
                                          const errorData = await tokenResponse.json();
                                          console.error("Token exchange failed:", errorData);
                                          throw new Error(errorData.error_description || "Token exchange failed");
                                        }
                                      } catch (error) {
                                        console.error("Desktop OAuth error:", error);
                                        toast(`OAuth failed: ${error.message}`, "error");
                                      }
                                      {% else %}
                                      // Web Mode: Standard OAuth flow
                                      toast("Starting Google Drive authentication...", "info");

                                      const clientId = "{{ google_client_id or 'YOUR_CLIENT_ID' }}";
                                      const clientSecret = "{{ google_client_secret or 'YOUR_CLIENT_SECRET' }}";

                                      // Check for saved refresh token first
                                      let refreshToken = localStorage.getItem('google_refresh_token');
                                      if (refreshToken) {
                                        try {
                                          toast("Using saved credentials...", "info");

                                          const refreshResponse = await fetch("https://oauth2.googleapis.com/token", {
                                            method: "POST",
                                            headers: { "Content-Type": "application/x-www-form-urlencoded" },
                                            body: new URLSearchParams({
                                              client_id: clientId,
                                              client_secret: clientSecret,
                                              refresh_token: refreshToken,
                                              grant_type: "refresh_token"
                                            })
                                          });

                                          if (refreshResponse.ok) {
                                            const tokenData = await refreshResponse.json();
                                            googleAccessToken = tokenData.access_token;
                                            toast("Google Drive connected instantly!", "success");
                                            await openDriveRestFallback();
                                            return;
                                          } else {
                                            localStorage.removeItem('google_refresh_token');
                                            toast("Saved credentials expired, getting new ones...", "warning");
                                          }
                                        } catch (error) {
                                          localStorage.removeItem('google_refresh_token');
                                        }
                                      }

                                      // Standard web OAuth flow
                                      try {
                                        const authUrl = `https://accounts.google.com/o/oauth2/v2/auth?` +
                                          `client_id=${encodeURIComponent(clientId)}&` +
                                          `redirect_uri=${encodeURIComponent('urn:ietf:wg:oauth:2.0:oob')}&` +
                                          `response_type=code&` +
                                          `scope=${encodeURIComponent('https://www.googleapis.com/auth/drive.readonly')}&` +
                                          `access_type=offline&` +
                                          `prompt=consent`;

                                        window.open(authUrl, "_blank");

                                        const authCode = prompt(`GOOGLE DRIVE AUTHORIZATION:

      1. Authorize in the browser window that opened
      2. Copy the authorization code from Google
      3. Paste it below:`);

                                        if (authCode && authCode.trim()) {
                                          toast("Exchanging code for access token...", "info");

                                          const tokenResponse = await fetch("https://oauth2.googleapis.com/token", {
                                            method: "POST",
                                            headers: { "Content-Type": "application/x-www-form-urlencoded" },
                                            body: new URLSearchParams({
                                              client_id: clientId,
                                              client_secret: clientSecret,
                                              code: authCode.trim(),
                                              grant_type: "authorization_code",
                                              redirect_uri: "urn:ietf:wg:oauth:2.0:oob"
                                            })
                                          });

                                          if (tokenResponse.ok) {
                                            const tokenData = await tokenResponse.json();
                                            googleAccessToken = tokenData.access_token;

                                            if (tokenData.refresh_token) {
                                              localStorage.setItem('google_refresh_token', tokenData.refresh_token);
                                              toast("Google Drive connected! Future access will be instant!", "success");
                                            } else {
                                              toast("Google Drive connected successfully!", "success");
                                            }

                                            await openDriveRestFallback();
                                          } else {
                                            const errorData = await tokenResponse.json();
                                            throw new Error(errorData.error_description || "Token exchange failed");
                                          }
                                        }
                                      } catch (error) {
                                        console.error("Desktop OAuth error:", error);
                                        toast(`Desktop OAuth failed: ${error.message}`, "error");

                                        // Fallback to device code flow
                                        toast("Trying device code flow...", "info");
                                        const success = await deviceFlowAuth();
                                        if (success) {
                                          toast("Connected via device flow!", "success");
                                          await openDriveRestFallback();
                                        } else {
                                          toast("All OAuth methods failed", "error");
                                        }
                                      }
                                      {% endif %}
                                    }
                                                // Expose handler globally for inline onclick
                                                window.openDrivePickerAndImport = openDrivePickerAndImport;

                                                // PKCE helper functions for secure desktop OAuth
                                                function generateCodeVerifier() {
                                                  const array = new Uint8Array(32);
                                                  crypto.getRandomValues(array);
                                                  return btoa(String.fromCharCode.apply(null, array))
                                                    .replace(/\+/g, '-')
                                                    .replace(/\//g, '_')
                                                    .replace(/=/g, '');
                                                }

                                                async function generateCodeChallenge(verifier) {
                                                  const encoder = new TextEncoder();
                                                  const data = encoder.encode(verifier);
                                                  const digest = await crypto.subtle.digest('SHA-256', data);
                                                  return btoa(String.fromCharCode.apply(null, new Uint8Array(digest)))
                                                    .replace(/\+/g, '-')
                                                    .replace(/\//g, '_')
                                                    .replace(/=/g, '');
                                                }
                                                // Desktop Device-Code flow (fallback)
                                                async function deviceFlowAuth() {
                                                  try {
                                                    const clientId = "{{ google_client_id or '' }}";
                                                    const clientSecret = "{{ google_client_secret or '' }}";
                                                    const scope = 'https://www.googleapis.com/auth/drive.readonly';
                                                    const codeResp = await fetch('https://oauth2.googleapis.com/device/code', {
                                                      method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                                                      body: new URLSearchParams({ client_id: clientId, scope })
                                                    });
                                                    if (!codeResp.ok) throw new Error('device/code failed');
                                                    const codeData = await codeResp.json();
                                                    const { user_code, verification_url, device_code, interval } = codeData;
                                                    alert(`Open: ${verification_url}\nEnter code: ${user_code}`);
                                                    window.open(verification_url, '_blank');
                                                    const pollMs = Math.max((interval || 5), 3) * 1000;
                                                    const start = Date.now();
                                                    while (Date.now() - start < 300000) {
                                                      const t = await fetch('https://oauth2.googleapis.com/token', {
                                                        method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                                                        body: new URLSearchParams({
                                                          client_id: clientId,
                                                          device_code,
                                                          grant_type: 'urn:ietf:params:oauth:grant-type:device_code',
                                                          ...(clientSecret ? { client_secret: clientSecret } : {})
                                                        })
                                                      });
                                                      if (t.status === 428 || t.status === 400) { await new Promise(r=>setTimeout(r,pollMs)); continue; }
                                                      if (!t.ok) throw new Error('device token failed');
                                                      const td = await t.json();
                                                      googleAccessToken = td.access_token;
                                                      if (td.refresh_token) localStorage.setItem('google_refresh_token', td.refresh_token);
                                                      return true;
                                                    }
                                                  } catch (e) { console.error('Device flow error', e); }
                                                  return false;
                                                }
                                                async function openDriveRestFallback() {
                                                  if (!googleAccessToken) {
                                                    toast("Please authenticate with Google Drive first", "error");
                                                    return;
                                                  }

                                                  try {
                                                    // List recent JSON files via Drive REST
                                                    const listResp = await fetch(
                                                      "https://www.googleapis.com/drive/v3/files?q=mimeType%3D%22application%2Fjson%22&fields=files(id%2Cname%2CmodifiedTime)&orderBy=modifiedTime%20desc",
                                                      {
                                                        headers: { Authorization: "Bearer " + googleAccessToken },
                                                      }
                                                    );
                                                    if (listResp.status === 401) {
                                                      const rt = localStorage.getItem('google_refresh_token');
                                                      if (rt) {
                                                        try {
                                                          const clientId = "{{ google_client_id or '' }}";
                                                          const clientSecret = "{{ google_client_secret or '' }}";
                                                          const r = await fetch('https://oauth2.googleapis.com/token', {
                                                            method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                                                            body: new URLSearchParams({
                                                              client_id: clientId, refresh_token: rt, grant_type: 'refresh_token',
                                                              ...(clientSecret ? { client_secret: clientSecret } : {})
                                                            })
                                                          });
                                                          if (r.ok) { const td = await r.json(); googleAccessToken = td.access_token; return await openDriveRestFallback(); }
                                                        } catch {}
                                                      }
                                                      const ok = await deviceFlowAuth();
                                                      if (ok) return await openDriveRestFallback();
                                                    }
                                                    if (!listResp.ok) throw new Error("Failed to list Drive files");

                                                    const listData = await listResp.json();
                                                    if (!listData.files || listData.files.length === 0) {
                                                      toast("No JSON files found in Google Drive", "info");
                                                      return;
                                                    }

                                                    // Show file selection dialog
                                                    const fileList = listData.files.map((f, i) => `${i + 1}. ${f.name} (${new Date(f.modifiedTime).toLocaleDateString()})`).join('\n');
                                                    const selection = prompt(`Select a file to import:\n\n${fileList}\n\nEnter the number (1-${listData.files.length}):`);

                                                    if (selection) {
                                                      const fileIndex = parseInt(selection) - 1;
                                                      if (fileIndex >= 0 && fileIndex < listData.files.length) {
                                                        const selectedFile = listData.files[fileIndex];

                                                        // Download the selected file
                                                        const contentResp = await fetch(
                                                          `https://www.googleapis.com/drive/v3/files/${selectedFile.id}?alt=media`,
                                                          {
                                                            headers: { Authorization: "Bearer " + googleAccessToken },
                                                          }
                                                        );

                                                        if (!contentResp.ok) throw new Error("Failed to download file");

                                                        const content = await contentResp.text();
                                                        const data = JSON.parse(content);

                                                        // Import the database
                                                        const res = await api("/import", "POST", data);
                                                        if (res && res.success) {
                                                          toast(`Database imported from ${selectedFile.name}`, "success");
                                                          await loadDatabases();
                                                        } else {
                                                          toast(`Import failed: ${res?.detail || "unknown error"}`, "error");
                                                        }
                                                      } else {
                                                        toast("Invalid selection", "error");
                                                      }
                                                    }
                                                  } catch (error) {
                                                    toast("Error accessing Google Drive: " + error.message, "error");
                                                  }
                                                }
                                                async function exportDbToDrive(name) {
                                                  toast("Opening browser for Google Drive authentication...", "info");

                                                  const currentPort = window.location.port || '8000';
                                                  const redirectUri = `http://127.0.0.1:${currentPort}/oauth/callback`;
                                                  const authUrl = `https://accounts.google.com/oauth/authorize?client_id={{ google_client_id or 'YOUR_CLIENT_ID' }}&redirect_uri=${encodeURIComponent(redirectUri)}&scope=https://www.googleapis.com/auth/drive.readonly&response_type=code&access_type=offline`;

                                                  window.open(authUrl, "_blank");

                                                  const authCode = prompt("After authorizing in the browser, copy the 'code' parameter from the redirect URL and paste it here:");
                                                  if (authCode) {
                                                    try {
                                                      // Exchange auth code for access token
                                                      const tokenResponse = await fetch("https://oauth2.googleapis.com/token", {
                                                        method: "POST",
                                                        headers: { "Content-Type": "application/x-www-form-urlencoded" },
                                                        body: new URLSearchParams({
                                                          client_id: "{{ google_client_id or 'YOUR_CLIENT_ID' }}",
                                                          client_secret: "{{ google_client_secret or 'YOUR_CLIENT_SECRET' }}",
                                                          code: authCode,
                                                          grant_type: "authorization_code",
                                                          redirect_uri: "http://localhost:8080/oauth/callback"
                                                        })
                                                      });

                                                      if (tokenResponse.ok) {
                                                        const tokenData = await tokenResponse.json();
                                                        googleAccessToken = tokenData.access_token;

                                                        // Export database
                                                        const res = await api("/export");
                                                        if (res) {
                                                          const blob = buildMultipart(
                                                            { name: name + ".json", parents: ["root"] },
                                                            JSON.stringify(res, null, 2)
                                                          );

                                                          const uploadResp = await fetch(
                                                            "https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart",
                                                            {
                                                              method: "POST",
                                                              headers: { Authorization: "Bearer " + googleAccessToken },
                                                              body: blob,
                                                            }
                                                          );

                                                          if (uploadResp.ok) {
                                                            toast(`Database exported to Google Drive as ${name}.json`, "success");
                                                          } else {
                                                            throw new Error("Upload failed");
                                                          }
                                                        }
                                                      } else {
                                                        throw new Error("Failed to exchange authorization code");
                                                      }
                                                    } catch (error) {
                                                      toast("Export failed: " + error.message, "error");
                                                    }
                                                  }
                                                }
                                                function buildMultipart(meta, body) {
                                                  const boundary = "-------314159265358979323846";
                                                  const delimiter = "\r\n--" + boundary + "\r\n";
                                                  const closeDelim = "\r\n--" + boundary + "--";
                                                  const contentType = "application/json";
                                                  const base64Data = btoa(unescape(encodeURIComponent(body)));
                                                  const multipartRequestBody =
                                                    delimiter +
                                                    "Content-Type: application/json\r\n\r\n" +
                                                    JSON.stringify(meta) +
                                                    delimiter +
                                                    "Content-Type: " +
                                                    contentType +
                                                    "\r\n" +
                                                    "Content-Transfer-Encoding: base64\r\n\r\n" +
                                                    base64Data +
                                                    closeDelim;
                                                  return new Blob([multipartRequestBody], {
                                                    type: "multipart/related; boundary=" + boundary,
                                                  });
                                                }
                                                {% endif %}

                                                const TYPE_OPTIONS = [
                                                  "integer",
                                                  "real",
                                                  "char",
                                                  "string",
                                                  "date",
                                                  "dateInvl",
                                                ];
                                                let tablesCache = [];
                                                const expandedTables = new Set();
                                                async function api(path, method = "GET", body) {
                                                  const res = await fetch(path, {
                                                    method,
                                                    headers: { "Content-Type": "application/json" },
                                                    body: body ? JSON.stringify(body) : undefined,
                                                  });
                                                  const text = await res.text();
                                                  try {
                                                    return JSON.parse(text);
                                                  } catch {
                                                    return text;
                                                  }
                                                }
                                                async function loadDatabases() {
                                                  const res = await api("/databases");
                                                  const list = document.getElementById("db-list");
                                                  list.innerHTML = "";
                                                  (res.databases || [])
                                                    .filter((n) => n !== "default")
                                                    .forEach((name) => {
                                                      const card = document.createElement("div");
                                                      card.className =
                                                        "rounded-xl border border-slate-800 bg-slate-950/80 p-4 flex items-center justify-between";
                                                      card.innerHTML = `<div class="min-w-0"><div class="font-semibold text-slate-100 truncate" title="${name}">${name}</div></div>
                                                    <div class="flex flex-wrap gap-2 items-center justify-end">
                                                      <button class="px-3 py-1.5 rounded bg-slate-800 hover:bg-slate-700 border border-slate-700 text-slate-200" data-open="${name}">Open</button>
                                                      <button class="px-3 py-1.5 rounded bg-emerald-600 hover:bg-emerald-500 text-white" data-store-drive="${name}">Store Drive</button>
                                                      <button class="px-3 py-1.5 rounded bg-rose-600 hover:bg-rose-500 text-white" data-delete-db="${name}">Delete</button>
                                                    </div>`;
                                                      list.appendChild(card);
                                                    });
                                                  Array.from(list.querySelectorAll("[data-open]")).forEach((btn) => {
                                                    btn.addEventListener("click", async (e) => {
                                                      e.preventDefault();
                                                      e.stopPropagation();
                                                      const name = btn.getAttribute("data-open");
                                                      // Optimistic view switch
                                                      const dbNameInput = document.getElementById("db-name");
                                                      if (dbNameInput) dbNameInput.value = name;
                                                      const activeNameInput = document.getElementById("active-db-name");
                                                      if (activeNameInput) activeNameInput.value = name;
                                                      enterTablesView();
                                                      await refresh();
                                                      window.scrollTo({ top: 0, behavior: "smooth" });
                                                      try {
                                                        const res = await api("/switch_database", "POST", { name });
                                                        if (!(res && res.status === "ok"))
                                                          toast(`Error: ${res?.detail || "failed"}`, "error");
                                                        else {
                                                          const ani = document.getElementById("active-db-name");
                                                          if (ani) ani.value = res.active || name;
                                                        }
                                                      } catch (err) {
                                                        toast("Error: failed to open database", "error");
                                                      }
                                                    });
                                                  });
                                                  Array.from(list.querySelectorAll("[data-store-drive]")).forEach(
                                                    (btn) => {
                                                      btn.addEventListener("click", async () => {
                                                        const name = btn.getAttribute("data-store-drive");
                                                        await exportDbToDrive(name);
                                                      });
                                                    }
                                                  );
                                                  Array.from(list.querySelectorAll("[data-delete-db]")).forEach((btn) => {
                                                    btn.addEventListener("click", async () => {
                                                      const name = btn.getAttribute("data-delete-db");
                                                      const res = await api("/delete_database", "POST", { name });
                                                      if (res && res.status === "ok") {
                                                        toast("Database deleted");
                                                        loadDatabases();
                                                      } else toast(`Error: ${res?.detail || "failed"}`, "error");
                                                    });
                                                  });
                                                }

                                                async function openDriveModal() {
                                                  const data = await api("/drive_files");
                                                  const files = (data && data.files) || [];
                                                  const modal = document.createElement("div");
                                                  modal.className =
                                                    "fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50";
                                                  modal.innerHTML = `
                                                    <div class="w-full max-w-2xl rounded-xl border border-slate-800 bg-slate-900 p-4">
                                                      <div class="flex items-center justify-between">
                                                        <h3 class="text-lg font-semibold">Load from Google Drive</h3>
                                                        <button class="px-2 py-1 rounded bg-slate-800 text-slate-200 border border-slate-700" data-close>Close</button>
                                                      </div>
                                                      <div class="mt-3 max-h-[60vh] overflow-auto divide-y divide-slate-800">
                                                        ${files
                                                          .map(
                                                            (f) => `
                                                          <div class='py-2 flex items-center justify-between'>
                                                            <div class='min-w-0'>
                                                              <div class='text-slate-100 truncate' title='${f.name}'>${
                                                              f.name
                                                            }</div>
                                                              <div class='text-xs text-slate-500'>${
                                                                f.modifiedTime || ""
                                                              }</div>
                                                            </div>
                                                            <button class='px-3 py-1.5 rounded bg-emerald-600 hover:bg-emerald-500 text-white' data-pick='${
                                                              f.id
                                                            }'>Load</button>
                                                          </div>`
                                                          )
                                                          .join("")}
                                                      </div>
                                                    </div>`;
                                                  document.body.appendChild(modal);
                                                  modal
                                                    .querySelector("[data-close]")
                                                    .addEventListener("click", () => modal.remove());
                                                  Array.from(modal.querySelectorAll("[data-pick]")).forEach((btn) => {
                                                    btn.addEventListener("click", async () => {
                                                      const file_id = btn.getAttribute("data-pick");
                                                      const name = prompt(
                                                        "Name for database loaded from Drive:",
                                                        "drive_db"
                                                      );
                                                      if (!name) return;
                                                      const res = await api("/load_drive", "POST", { name, file_id });
                                                      if (res && res.status === "ok") {
                                                        toast("Loaded from Drive");
                                                        modal.remove();
                                                        await loadDatabases();
                                                      } else toast(`Error: ${res?.detail || "failed"}`, "error");
                                                    });
                                                  });
                                                }
                                                function enterTablesView() {
                                                  document.getElementById("dbView").classList.add("hidden");
                                                  document.getElementById("tableView").classList.remove("hidden");
                                                  refresh();
                                                  const t = document.getElementById("pageTitle");
                                                  const s = document.getElementById("pageSubtitle");
                                                  if (t) t.textContent = "Tables";
                                                  if (s) {
                                                    s.textContent = "";
                                                    s.classList.add("hidden");
                                                  }
                                                  // Reflect active DB name for editing
                                                  api("/databases").then((d) => {
                                                    try {
                                                      document.getElementById("active-db-name").value = d.active || "";
                                                    } catch {}
                                                  });
                                                }
                                                function backToDatabases() {
                                                  document.getElementById("tableView").classList.add("hidden");
                                                  document.getElementById("dbView").classList.remove("hidden");
                                                  loadDatabases();
                                                  const t = document.getElementById("pageTitle");
                                                  const s = document.getElementById("pageSubtitle");
                                                  if (t) t.textContent = "Databases";
                                                  if (s) {
                                                    s.textContent = "";
                                                    s.classList.add("hidden");
                                                  }
                                                }
                                                async function createDbLanding() {
                                                  const name = document.getElementById("new-db-name").value.trim();
                                                  if (!name) return toast("Error: provide database name", "error");
                                                  const res = await api("/create_database", "POST", { name });
                                                  if (res && res.status === "ok") {
                                                    toast("Success: database created");
                                                    // Optimistically add to list
                                                    const list = document.getElementById("db-list");
                                                    const card = document.createElement("div");
                                                    card.className =
                                                      "rounded-xl border border-slate-800 bg-slate-950/80 p-4 flex items-center justify-between";
                                                    card.innerHTML = `<div class="min-w-0"><div class="font-semibold text-slate-100 truncate" title="${name}">${name}</div></div>
                                                      <div class="flex flex-wrap gap-2 items-center justify-end">
                                                        <button class="px-3 py-1.5 rounded bg-slate-800 hover:bg-slate-700 border border-slate-700 text-slate-200" data-open="${name}">Open</button>
                                                        <button class="px-3 py-1.5 rounded bg-emerald-600 hover:bg-emerald-500 text-white" data-store-drive="${name}">Store Drive</button>
                                                        <button class="px-3 py-1.5 rounded bg-rose-600 hover:bg-rose-500 text-white" data-delete-db="${name}">Delete</button>
                                                      </div>`;
                                                    list.prepend(card);
                                                    // Wire the new buttons
                                                    card
                                                      .querySelector("[data-open]")
                                                      ?.addEventListener("click", async () => {
                                                        const dbNameInput = document.getElementById("db-name");
                                                        if (dbNameInput) dbNameInput.value = name;
                                                        const activeNameInput = document.getElementById("active-db-name");
                                                        if (activeNameInput) activeNameInput.value = name;
                                                        enterTablesView();
                                                        await refresh();
                                                        try {
                                                          const res2 = await api("/switch_database", "POST", { name });
                                                          if (!(res2 && res2.status === "ok"))
                                                            toast(`Error: ${res2?.detail || "failed"}`, "error");
                                                          else {
                                                            const ani = document.getElementById("active-db-name");
                                                            if (ani) ani.value = res2.active || name;
                                                          }
                                                        } catch {
                                                          toast("Error: failed to open database", "error");
                                                        }
                                                      });
                                                    card
                                                      .querySelector("[data-store-drive]")
                                                      ?.addEventListener("click", async () => {
                                                        const res3 = await api("/save_drive", "POST", { name });
                                                        if (res3 && res3.status === "ok")
                                                          toast("Saved to Drive: " + res3.file_id);
                                                        else toast(`Error: ${res3?.detail || "failed"}`, "error");
                                                      });
                                                    card
                                                      .querySelector("[data-delete-db]")
                                                      ?.addEventListener("click", async () => {
                                                        const res4 = await api("/delete_database", "POST", { name });
                                                        if (res4 && res4.status === "ok") {
                                                          toast("Database deleted");
                                                          loadDatabases();
                                                        } else toast(`Error: ${res4?.detail || "failed"}`, "error");
                                                      });
                                                  } else toast(`Error: ${res?.detail || "failed"}`, "error");
                                                }
                                                function addColumnRow() {
                                                  const container = document.getElementById("schema-rows");
                                                  const row = document.createElement("div");
                                                  row.className = "grid grid-cols-12 gap-3 items-center";
                                                  row.innerHTML = `
                                                  <input class="col-span-5 px-3 py-2 rounded bg-slate-800/60 border border-slate-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 text-slate-100" placeholder="column name" />
                                                  <select class="col-span-5 px-3 py-2 rounded bg-slate-800/60 border border-slate-700 text-slate-100"></select>
                                                  <button class="col-span-2 w-full px-3 py-2 rounded bg-rose-600 hover:bg-rose-500 text-white text-sm whitespace-nowrap flex items-center justify-center" type="button">Remove</button>
                                                `;
                                                  const select = row.querySelector("select");
                                                  TYPE_OPTIONS.forEach((t) => {
                                                    const o = document.createElement("option");
                                                    o.value = t;
                                                    o.textContent = t;
                                                    select.appendChild(o);
                                                  });
                                                  row.querySelector("button").onclick = () => row.remove();
                                                  container.appendChild(row);
                                                }
                                                async function createTable() {
                                                  const name = document.getElementById("tname").value.trim();
                                                  const rows = Array.from(
                                                    document.querySelectorAll("#schema-rows > div")
                                                  );
                                                  const schema = rows
                                                    .map((r) => ({
                                                      name: r.querySelector("input").value.trim(),
                                                      type: r.querySelector("select").value,
                                                    }))
                                                    .filter((c) => c.name);
                                                  if (!name) {
                                                    toast("Error: provide table name", "error");
                                                    return;
                                                  }
                                                  if (schema.length === 0) {
                                                    toast("Error: add at least one column", "error");
                                                    return;
                                                  }
                                                  try {
                                                    const res = await api("/create_table", "POST", { name, schema });
                                                    if (res && res.status === "ok") {
                                                      await refresh();
                                                      toast("Success: table created");
                                                    } else {
                                                      const msg =
                                                        typeof res === "string" ? res : res?.detail || "create failed";
                                                      toast(`Error: ${msg}`, "error");
                                                    }
                                                  } catch (e) {
                                                    toast("Error: create failed", "error");
                                                  }
                                                }
                                                function buildInsertForm() {
                                                  const sel = document.getElementById("insert-table");
                                                  const name = sel.value;
                                                  const target = document.getElementById("insert-form");
                                                  target.innerHTML = "";
                                                  const t = tablesCache.find((x) => x.name === name);
                                                  if (!t) return;
                                                  t.columns.forEach((c) => {
                                                    const row = document.createElement("div");
                                                    row.className = "grid grid-cols-12 gap-3 items-center";
                                                    let control = "";
                                                    if (c.type === "integer" || c.type === "real") {
                                                      const step = c.type === "integer" ? "1" : "any";
                                                      control = `<input data-col="${c.name}" type="number" step="${step}" class="col-span-8 px-3 py-2 rounded bg-slate-800/60 border border-slate-700" placeholder="${c.type}">`;
                                                    } else if (c.type === "char") {
                                                      control = `<input data-col="${c.name}" maxlength="1" class="col-span-8 px-3 py-2 rounded bg-slate-800/60 border border-slate-700" placeholder="char">`;
                                                    } else if (c.type === "string") {
                                                      control = `<input data-col="${c.name}" class="col-span-8 px-3 py-2 rounded bg-slate-800/60 border border-slate-700" placeholder="string">`;
                                                    } else if (c.type === "date") {
                                                      control = `<input data-col="${c.name}" type="date" class="col-span-8 px-3 py-2 rounded bg-slate-800/60 border border-slate-700">`;
                                                    } else if (c.type === "dateInvl") {
                                                      control = `<div class="col-span-8 grid grid-cols-2 gap-2"><input data-col="${c.name}" data-range="start" type="date" class="px-3 py-2 rounded bg-slate-800/60 border border-slate-700"><input data-col="${c.name}" data-range="end" type="date" class="px-3 py-2 rounded bg-slate-800/60 border border-slate-700"></div>`;
                                                    }
                                                    row.innerHTML = `
                                                      <div class="col-span-4 text-sm text-slate-300">${c.name} <span class="text-slate-500">(${c.type})</span></div>
                                                      ${control}
                                                    `;
                                                    target.appendChild(row);
                                                  });
                                                }

                                                async function insertRow() {
                                                  const table = document.getElementById("insert-table").value;
                                                  const t = tablesCache.find((x) => x.name === table);
                                                  if (!t) {
                                                    toast("Select a table", "error");
                                                    return;
                                                  }
                                                  const values = {};
                                                  t.columns.forEach((c) => {
                                                    if (c.type === "dateInvl") {
                                                      const start = document.querySelector(
                                                        `[data-col="${c.name}"][data-range="start"]`
                                                      )?.value;
                                                      const end = document.querySelector(
                                                        `[data-col="${c.name}"][data-range="end"]`
                                                      )?.value;
                                                      if (start || end) values[c.name] = { start, end };
                                                    } else {
                                                      const el = document.querySelector(`[data-col="${c.name}"]`);
                                                      if (!el) return;
                                                      let v = el.value;
                                                      if (v === "") return;
                                                      if (c.type === "integer") v = parseInt(v, 10);
                                                      if (c.type === "real") v = parseFloat(v);
                                                      values[c.name] = v;
                                                    }
                                                  });
                                                  try {
                                                    const res = await api("/insert_row", "POST", { table, values });
                                                    if (res && res.status === "ok") {
                                                      toast("Success: row added", "success");
                                                      await refresh();
                                                    } else {
                                                      toast(`Error: ${res?.detail || "insert failed"}`, "error");
                                                    }
                                                  } catch (e) {
                                                    toast("Insert failed", "error");
                                                  }
                                                }
                                                async function unionTables() {
                                                  const left = document.getElementById("left").value;
                                                  const right = document.getElementById("right").value;
                                                  const name = document.getElementById("union-name")?.value?.trim() || "";
                                                  try {
                                                    const res = await api("/union", "POST", {
                                                      left,
                                                      right,
                                                      name: name || undefined,
                                                    });
                                                    if (res && res.name) {
                                                      toast("Union created: " + res.name);
                                                      await refresh();
                                                    } else {
                                                      toast(`Error: ${res?.detail || "union failed"}`, "error");
                                                    }
                                                  } catch (e) {
                                                    toast("Error: union failed", "error");
                                                  }
                                                }
                                                async function refresh() {
                                                  const list = await api("/tables");
                                                  const sel = document.getElementById("insert-table");
                                                  const lsel = document.getElementById("left");
                                                  const rsel = document.getElementById("right");
                                                  [sel, lsel, rsel].forEach((s) => {
                                                    if (s) s.innerHTML = "";
                                                  });
                                                  tablesCache = list.tables || [];
                                                  tablesCache.forEach((t) => {
                                                    if (sel) {
                                                      const o1 = new Option(t.name, t.name);
                                                      sel.add(o1);
                                                    }
                                                    const o2 = new Option(t.name, t.name);
                                                    lsel.add(o2);
                                                    const o3 = new Option(t.name, t.name);
                                                    rsel.add(o3);
                                                  });
                                                  if (sel) buildInsertForm();
                                                  const grid = document.getElementById("tables");
                                                  grid.innerHTML = "";
                                                  list.tables.forEach((t) => {
                                                    const card = document.createElement("div");
                                                    card.className =
                                                      "rounded-xl border border-slate-800 bg-slate-950/80 p-4 shadow-xl hover:shadow-2xl transition";
                                                    card.innerHTML = `
                                                    <div class="flex items-center justify-between">
                                                      <div class="min-w-0">
                                                        <h3 class="text-lg font-semibold text-slate-100 truncate" title="${
                                                          t.name
                                                        }">${t.name}</h3>
                                                        <div class="text-xs text-slate-400 mt-0.5">${
                                                          t.rowCount
                                                        } rows</div>
                                                      </div>
                                                      <div class="flex items-center gap-2">
                                                        <button data-view="${
                                                          t.name
                                                        }" class="view-btn px-3 py-1.5 rounded bg-slate-800 hover:bg-slate-700 border border-slate-700 text-slate-200">${
                                                      expandedTables.has(t.name) ? "Close" : "View"
                                                    }</button>
                                                        <button data-name="${
                                                          t.name
                                                        }" class="px-3 py-1.5 rounded bg-rose-600 hover:bg-rose-500 text-white delete-btn">Delete</button>
                                                      </div>
                                                    </div>
                                                    <div class="mt-3 text-sm text-slate-300 flex flex-wrap gap-2">
                                                      ${t.columns
                                                        .map(
                                                          (c) =>
                                                            `<span class='px-2 py-1 rounded bg-slate-800 border border-slate-700'>${c.name}: ${c.type}</span>`
                                                        )
                                                        .join("")}
                                                    </div>
                                                    <div class="mt-3 rounded border border-slate-800 hidden${
                                                      t.rows && t.rows.length > 30 ? " overflow-auto max-h-64" : ""
                                                    }" data-detail="${t.name}">
                                                      <table class="min-w-full text-sm">
                                                        <thead class="bg-slate-800/90 sticky top-0 z-10">
                                                          <tr>
                                                            ${t.columns
                                                              .map(
                                                                (c) =>
                                                                  `<th class='text-left px-3 py-2 font-semibold text-slate-100 border-b border-slate-700 uppercase tracking-wider'>${c.name}</th>`
                                                              )
                                                              .join("")}
                                                            <th class='text-left px-3 py-2 font-semibold text-slate-100 border-b border-slate-700 uppercase tracking-wider'>Add row</th>
                                                          </tr>
                                                        </thead>
                                                        <tbody>
                                                          <tr>
                                                            ${t.columns
                                                              .map((c) => {
                                                                if (c.type === "date") {
                                                                  return `<td class='px-3 py-2 border-b border-slate-800'><input data-add-col='${c.name}' type='date' class='w-full px-2 py-1 rounded bg-slate-800/60 border border-slate-700'></td>`;
                                                                }
                                                                if (c.type === "dateInvl") {
                                                                  return `<td class='px-3 py-2 border-b border-slate-800'><div class='grid grid-cols-2 gap-1'><input data-add-col='${c.name}' data-range='start' type='date' class='px-2 py-1 rounded bg-slate-800/60 border border-slate-700'><input data-add-col='${c.name}' data-range='end' type='date' class='px-2 py-1 rounded bg-slate-800/60 border border-slate-700'></div></td>`;
                                                                }
                                                                const typeAttr =
                                                                  c.type === "integer"
                                                                    ? "number step='1'"
                                                                    : c.type === "real"
                                                                    ? "number step='any'"
                                                                    : "text";
                                                                return `<td class='px-3 py-2 border-b border-slate-800'><input data-add-col='${
                                                                  c.name
                                                                }' type='${typeAttr.split(" ")[0]}' ${
                                                                  typeAttr.includes("step")
                                                                    ? `step='${
                                                                        typeAttr.split("step='")[1]?.split("'")[0]
                                                                      }'`
                                                                    : ""
                                                                } class='w-full px-2 py-1 rounded bg-slate-800/60 border border-slate-700'></td>`;
                                                              })
                                                              .join("")}
                                                            <td class='px-3 py-2 border-b border-slate-800'><button data-add='${
                                                              t.name
                                                            }' class='px-3 py-1.5 rounded bg-emerald-600 hover:bg-emerald-500 text-white'>Add</button></td>
                                                          </tr>
                                                          ${t.rows
                                                            .map(
                                                              (r) => `
                                                            <tr class='even:bg-slate-900/40 hover:bg-slate-900/60'>
                                                              ${t.columns
                                                                .map((c) => {
                                                                  const v = (r || {})[c.name];
                                                                  const rendered =
                                                                    v &&
                                                                    typeof v === "object" &&
                                                                    "start" in v &&
                                                                    "end" in v
                                                                      ? `${v.start} → ${v.end}`
                                                                      : v ?? "";
                                                                  return `<td class='px-3 py-2 text-slate-300 border-b border-slate-800 truncate' title='${rendered}'>${rendered}</td>`;
                                                                })
                                                                .join("")}
                                                              <td></td>
                                                            </tr>
                                                          `
                                                            )
                                                            .join("")}
                                                        </tbody>
                                                      </table>
                                                    </div>
                                                  `;
                                                    grid.appendChild(card);
                                                    // auto-expand if remembered
                                                    if (expandedTables.has(t.name)) {
                                                      const detail = card.querySelector(`[data-detail='${t.name}']`);
                                                      detail?.classList.remove("hidden");
                                                    }
                                                  });
                                                  Array.from(document.querySelectorAll(".delete-btn")).forEach((btn) => {
                                                    btn.addEventListener("click", async () => {
                                                      const name = btn.getAttribute("data-name");
                                                      const res = await api("/delete_table", "POST", { name });
                                                      if (res && res.status === "deleted")
                                                        toast(`Success: deleted ${name}`);
                                                      else toast(`Error: ${res?.detail || "delete failed"}`, "error");
                                                      expandedTables.delete(name);
                                                      await refresh();
                                                    });
                                                  });
                                                  // Hook up per-table view: expand/collapse detail inside the same card
                                                  Array.from(document.querySelectorAll(".view-btn")).forEach((btn) => {
                                                    btn.addEventListener("click", () => {
                                                      const name = btn.getAttribute("data-view");
                                                      const card = btn.closest("div.rounded-xl");
                                                      const detail = card?.querySelector(`[data-detail='${name}']`);
                                                      if (!detail) return;
                                                      const isHidden = detail.classList.contains("hidden");
                                                      if (isHidden) {
                                                        detail.classList.remove("hidden");
                                                        expandedTables.add(name);
                                                        btn.textContent = "Close";
                                                      } else {
                                                        detail.classList.add("hidden");
                                                        expandedTables.delete(name);
                                                        btn.textContent = "View";
                                                      }
                                                    });
                                                  });

                                                  // Hook up per-table add buttons
                                                  Array.from(document.querySelectorAll("[data-add]")).forEach((btn) => {
                                                    btn.addEventListener("click", async () => {
                                                      const table = btn.getAttribute("data-add");
                                                      const t = tablesCache.find((x) => x.name === table);
                                                      if (!t) return;
                                                      const values = {};
                                                      t.columns.forEach((c) => {
                                                        if (c.type === "dateInvl") {
                                                          const start = btn
                                                            .closest("tr")
                                                            .querySelector(
                                                              `[data-add-col="${c.name}"][data-range="start"]`
                                                            )?.value;
                                                          const end = btn
                                                            .closest("tr")
                                                            .querySelector(
                                                              `[data-add-col="${c.name}"][data-range="end"]`
                                                            )?.value;
                                                          if (start || end) values[c.name] = { start, end };
                                                        } else {
                                                          const el = btn
                                                            .closest("tr")
                                                            .querySelector(`[data-add-col="${c.name}"]`);
                                                          if (!el) return;
                                                          let v = el.value;
                                                          if (v === "") return;
                                                          if (c.type === "integer") v = parseInt(v, 10);
                                                          if (c.type === "real") v = parseFloat(v);
                                                          values[c.name] = v;
                                                        }
                                                      });
                                                      try {
                                                        const res = await api("/insert_row", "POST", { table, values });
                                                        if (res && res.status === "ok") {
                                                          toast("Success: row added");
                                                          expandedTables.add(table);
                                                          await refresh();
                                                        } else {
                                                          toast(`Error: ${res?.detail || "insert failed"}`, "error");
                                                        }
                                                      } catch (e) {
                                                        toast("Error: insert failed", "error");
                                                      }
                                                    });
                                                  });
                                                }
                                                async function createDb() {
                                                  const name = document.getElementById("db-name").value.trim();
                                                  if (!name) return toast("Error: provide database name", "error");
                                                  const res = await api("/create_database", "POST", { name });
                                                  if (res && res.status === "ok") {
                                                    toast("Success: database created");
                                                    refresh();
                                                  } else toast(`Error: ${res?.detail || "failed"}`, "error");
                                                }
                                                async function switchDb() {
                                                  const name = document.getElementById("db-name").value.trim();
                                                  if (!name) return toast("Error: provide database name", "error");
                                                  const res = await api("/switch_database", "POST", { name });
                                                  if (res && res.status === "ok") {
                                                    toast("Success: switched");
                                                    refresh();
                                                  } else toast(`Error: ${res?.detail || "failed"}`, "error");
                                                }
                                                async function saveLocal() {
                                                  const name = document.getElementById("db-name").value.trim();
                                                  const res = await api("/save", "POST", { name: name || undefined });
                                                  if (res && res.status === "ok") toast("Saved locally");
                                                  else toast(`Error: ${res?.detail || "failed"}`, "error");
                                                }
                                                async function loadLocal() {
                                                  const name = document.getElementById("db-name").value.trim();
                                                  if (!name) return toast("Error: provide database name", "error");
                                                  const res = await api("/load", "POST", { name });
                                                  if (res && res.status === "ok") {
                                                    toast("Loaded locally");
                                                    refresh();
                                                  } else toast(`Error: ${res?.detail || "failed"}`, "error");
                                                }
                                                async function saveDrive() {
                                                  const name = document.getElementById("db-name").value.trim();
                                                  const folder_id =
                                                    document.getElementById("drive-folder").value.trim() || undefined;
                                                  const res = await api("/save_drive", "POST", {
                                                    name: name || undefined,
                                                    folder_id,
                                                  });
                                                  if (res && res.status === "ok") toast("Saved to Drive: " + res.file_id);
                                                  else toast(`Error: ${res?.detail || "failed"}`, "error");
                                                }
                                                async function loadDrive() {
                                                  const name = document.getElementById("db-name").value.trim();
                                                  const file_id = document.getElementById("drive-file").value.trim();
                                                  if (!name || !file_id)
                                                    return toast("Error: provide database name and file id", "error");
                                                  const res = await api("/load_drive", "POST", { name, file_id });
                                                  if (res && res.status === "ok") {
                                                    toast("Loaded from Drive");
                                                    refresh();
                                                  } else toast(`Error: ${res?.detail || "failed"}`, "error");
                                                }
                                                function toast(text, type = "success") {
                                                  const t = document.getElementById("toast");
                                                  try {
                                                    t.textContent =
                                                      typeof text === "string" ? text : JSON.stringify(text);
                                                  } catch {
                                                    t.textContent = String(text);
                                                  }
                                                  t.classList.remove("opacity-0");
                                                  t.classList.remove(
                                                    "bg-emerald-600/90",
                                                    "border-emerald-500/40",
                                                    "bg-rose-600/90",
                                                    "border-rose-500/40"
                                                  );
                                                  if (type === "error")
                                                    t.classList.add("bg-rose-600/90", "border-rose-500/40");
                                                  else t.classList.add("bg-emerald-600/90", "border-emerald-500/40");
                                                  setTimeout(() => t.classList.add("opacity-0"), 2500);
                                                }
                                                document.addEventListener("DOMContentLoaded", async () => {
                                                  addColumnRow();
                                                  loadDatabases();
                                                  document
                                                    .getElementById("backToDb")
                                                    .addEventListener("click", backToDatabases);
                                                  const t = document.getElementById("pageTitle");
                                                  const s = document.getElementById("pageSubtitle");
                                                  if (t) t.textContent = "Databases";
                                                  if (s) {
                                                    s.textContent = "";
                                                    s.classList.add("hidden");
                                                  }

                                                  // Initialize Google APIs with better error handling
                                                  {% if google_client_id %}
                                                  try {
                                                    console.log("🚀 Starting Google API initialization...");
                                                    console.log("📋 OAuth Config:", {
                                                      clientId: "{{ google_client_id }}",
                                                      scopes: "drive.readonly only",
                                                      userAgent: navigator.userAgent,
                                                      currentUser: "Check browser account"
                                                    });
                                                    await initGapi();
                                                    console.log("✅ Google API initialization completed");

                                                    // Add diagnostic button for OAuth issues
                                                    setTimeout(() => {
                                                      if (document.querySelector('.oauth-debug')) return;
                                                      const debugBtn = document.createElement('button');
                                                      debugBtn.className = 'oauth-debug bg-blue-600 text-white px-3 py-1 rounded text-sm fixed top-4 right-4 z-50';
                                                      debugBtn.textContent = 'OAuth Debug';
                                                      debugBtn.onclick = () => {
                                                        console.log("🔍 OAuth Debug Info:");
                                                        console.log("- Client ID:", "{{ google_client_id }}");
                                                        console.log("- Current URL:", window.location.href);
                                                        console.log("- User Agent:", navigator.userAgent);
                                                        console.log("- Cookies:", document.cookie);
                                                        console.log("- LocalStorage:", localStorage);
                                                        alert("Check browser console (F12) for detailed OAuth debug information");
                                                      };
                                                      document.body.appendChild(debugBtn);
                                                    }, 2000);

                                                  } catch (error) {
                                                    console.error("❌ Google API initialization failed:", error);
                                                    toast("Google Drive integration failed to load. Check console (F12) for details.", "warning");
                                                  }
                                                  {% endif %}
                                                });
                                                async function renameActiveDb() {
                                                  const input = document.getElementById("active-db-name");
                                                  const newName = (input?.value || "").trim();
                                                  if (!newName) return toast("Error: provide database name", "error");
                                                  const res = await api("/rename_database", "POST", { new: newName });
                                                  if (res && res.status === "ok") {
                                                    toast("Database renamed");
                                                    loadDatabases();
                                                  } else toast(`Error: ${res?.detail || "failed"}`, "error");
                                                }

                                                // Ensure global handler always exists for the button
                                                if (typeof window.openDrivePickerAndImport !== "function") {
                                                  {% if is_desktop %}
                                                  window.openDrivePickerAndImport = async function () {
                                                    try {
                                                      // If full desktop flow was defined earlier, call it
                                                      if (typeof openDriveRestFallback === "function" && typeof deviceFlowAuth === "function") {
                                                        // Prefer device flow minimal path to guarantee availability
                                                        const ok = await deviceFlowAuth();
                                                        if (ok) {
                                                          await openDriveRestFallback();
                                                          return;
                                                        }
                                                      }
                                                      toast("Desktop Google auth not available", "error");
                                                    } catch (e) {
                                                      console.error("Desktop Load Drive fallback failed", e);
                                                      toast("Load Drive failed", "error");
                                                    }
                                                  };
                                                  {% else %}
                                                  window.openDrivePickerAndImport = async function () {
                                                    try {
                                                      // Try to authorize; if picker isn't available, use REST fallback
                                                      if (typeof ensureGoogleAuth === "function") {
                                                        try { await ensureGoogleAuth(); } catch {}
                                                      }
                                                      if (typeof openDriveRestFallback === "function") {
                                                        await openDriveRestFallback();
                                                      } else {
                                                        throw new Error("Drive fallback not available");
                                                      }
                                                    } catch (e) {
                                                      console.error("Web Load Drive fallback failed", e);
                                                      toast("Load Drive failed", "error");
                                                    }
                                                  };
                                                  {% endif %}
                                                }
    </script>
  </head>
  <body
    class="min-h-screen bg-gradient-to-br from-slate-950 via-slate-900 to-slate-950 text-slate-100"
  >
    <div
      id="toast"
      class="fixed top-4 right-4 px-4 py-2 rounded bg-emerald-600/90 backdrop-blur border border-emerald-500/40 shadow-lg transition-opacity opacity-0"
    ></div>
    <header class="max-w-7xl mx-auto px-6 py-6">
      <div class="text-center">
        <h1 id="pageTitle" class="text-3xl font-bold tracking-tight">
          Databases {% if is_desktop %}
          <span class="text-sm bg-blue-100 text-blue-800 px-2 py-1 rounded ml-2"
            >Desktop</span
          >
          {% endif %}
        </h1>
        <p id="pageSubtitle" class="text-slate-400 mt-1 hidden"></p>
      </div>
    </header>
    <main class="max-w-7xl mx-auto px-6 pb-16">
      <section id="dbView" class="grid grid-cols-12 gap-6">
        <div
          class="col-span-12 lg:col-span-8 lg:col-start-3 rounded-2xl border border-slate-800 bg-slate-900/60 p-5"
        >
          <div class="mt-2 grid grid-cols-12 gap-3 text-sm">
            <input
              id="new-db-name"
              placeholder="new database name"
              class="col-span-8 col-start-3 px-3 py-2 rounded bg-slate-800/60 border border-slate-700 text-center"
            />
            <div class="col-span-6 col-start-4 flex gap-2">
              <button
                class="w-full px-3 py-2 rounded bg-indigo-600 hover:bg-indigo-500 text-white"
                onclick="createDbLanding()"
              >
                Create
              </button>
              <button
                class="w-full px-3 py-2 rounded bg-slate-800 hover:bg-slate-700 border border-slate-700 text-slate-200"
                onclick="(async () => { try { console.log('Button clicked'); await openDrivePickerAndImport(); } catch(e) { console.error('Button error:', e); toast('Error: ' + e.message, 'error'); } })()"
              >
                Load Drive
              </button>
            </div>
          </div>
        </div>
        <div
          class="col-span-12 lg:col-span-8 lg:col-start-3 rounded-2xl border border-slate-800 bg-slate-900/60 p-5"
        >
          <div id="db-list" class="mt-4 space-y-3"></div>
        </div>
      </section>
      <section id="tableView" class="hidden grid grid-cols-12 gap-6 mt-6">
        <div class="col-span-12 flex items-center justify-start gap-3">
          <button
            id="backToDb"
            class="px-3 py-1.5 rounded bg-slate-800 hover:bg-slate-700 border border-slate-700 text-slate-200"
          >
            Back to databases
          </button>
        </div>
        <section class="col-span-12 lg:col-span-5 space-y-6">
          <div class="rounded-2xl border border-slate-800 bg-slate-900/60 p-5">
            <div class="mt-4 flex items-center justify-center gap-3 text-sm">
              <input
                id="active-db-name"
                class="w-full max-w-md px-3 py-2 rounded bg-slate-800/60 border border-slate-700 text-center"
                placeholder="database name"
              />
              <button
                class="px-3 py-2 rounded bg-indigo-600 hover:bg-indigo-500 text-white"
                onclick="renameActiveDb()"
              >
                Save
              </button>
            </div>
          </div>
          <div class="rounded-2xl border border-slate-800 bg-slate-900/60 p-5">
            <h2 class="text-xl font-semibold">Create Table</h2>
            <div class="mt-4 space-y-3">
              <input
                id="tname"
                class="w-full px-3 py-2 rounded bg-slate-800/60 border border-slate-700 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                placeholder="table name"
              />
              <div class="space-y-3" id="schema-rows"></div>
              <div class="flex items-center gap-3">
                <button
                  class="px-3 py-2 rounded bg-slate-800 hover:bg-slate-700 border border-slate-700"
                  type="button"
                  onclick="addColumnRow()"
                >
                  Add column
                </button>
                <button
                  class="px-4 py-2 rounded bg-indigo-600 hover:bg-indigo-500 text-white"
                  type="button"
                  onclick="createTable()"
                >
                  Create
                </button>
              </div>
            </div>
          </div>
          <div class="rounded-2xl border border-slate-800 bg-slate-900/60 p-5">
            <h2 class="text-xl font-semibold">Union</h2>
            <div class="mt-4 grid grid-cols-12 gap-3">
              <input
                id="union-name"
                placeholder="result table name (optional)"
                class="col-span-12 px-3 py-2 rounded bg-slate-800/60 border border-slate-700 text-slate-100"
              />
              <select
                id="left"
                class="col-span-5 min-w-0 truncate px-3 py-2 rounded bg-slate-800/60 border border-slate-700"
              ></select>
              <select
                id="right"
                class="col-span-5 min-w-0 truncate px-3 py-2 rounded bg-slate-800/60 border border-slate-700"
              ></select>
              <div class="col-span-2">
                <button
                  class="w-full whitespace-nowrap px-4 py-2 rounded bg-fuchsia-600 hover:bg-fuchsia-500 text-white"
                  onclick="unionTables()"
                >
                  Go
                </button>
              </div>
            </div>
          </div>
        </section>
        <section class="col-span-12 lg:col-span-7">
          <div id="tables" class="grid grid-cols-1 gap-6"></div>
        </section>
      </section>
    </main>
  </body>
</html>
