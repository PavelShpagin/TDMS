sequenceDiagram
    autonumber
    participant U as User
    participant UI as Web/Desktop UI
    participant API as FastAPI/Desktop API
    participant OAuth as Google OAuth
    participant Drive as Google Drive API
    participant DB as Database
    participant FS as File System

    Note over U,Drive: Google Drive Integration Flow

    U->>UI: Click "Load Drive" or "Save Drive"
    
    alt First Time (No Auth)
        UI->>OAuth: Check authentication status
        OAuth-->>UI: Not authenticated
        UI->>OAuth: Start OAuth flow
        
        alt Desktop Mode
            OAuth->>U: Open system browser
            U->>OAuth: Grant permissions
            OAuth-->>UI: Authorization code
        else Web Mode
            OAuth->>UI: Show Google login popup
            U->>OAuth: Grant permissions  
            OAuth-->>UI: Access token
        end
        
        UI->>API: Store auth credentials
    else Already Authenticated
        UI->>OAuth: Use existing credentials
    end

    alt Load from Drive
        UI->>Drive: List database files
        Drive-->>UI: File list with metadata
        UI->>U: Show file picker dialog
        U->>UI: Select file
        UI->>Drive: Download file content
        Drive-->>UI: JSON database content
        UI->>API: POST /import_database {name, data}
        API->>DB: Create database from JSON
        
        Note over API,DB: Handle duplicate names
        alt Name exists
            API->>API: Add suffix (1), (2), etc.
        end
        
        DB-->>API: Database created
        API->>FS: Save to local storage
        API-->>UI: {"status": "ok", "name": "final_name"}
        UI-->>U: "Database loaded from Drive"

    else Save to Drive
        UI->>API: GET /export {name}
        API->>DB: Export database to JSON
        DB-->>API: JSON content
        API-->>UI: Database JSON
        UI->>Drive: Upload file {name.json, content}
        Drive-->>UI: Upload success
        UI-->>U: "Database saved to Drive"
    end

    Note over U,FS: Error Handling
    alt Network Error
        Drive-->>UI: Connection failed
        UI-->>U: "Network error - check connection"
    else Auth Error  
        OAuth-->>UI: Token expired
        UI->>OAuth: Refresh token or re-authenticate
    else Drive API Error
        Drive-->>UI: API quota exceeded
        UI-->>U: "Drive API limit reached - try later"
    end
